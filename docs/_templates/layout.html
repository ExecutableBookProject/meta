{% extends "!layout.html" %}

{%- block extrahead %}

{% if "feature-vote" in sourcename %}
<link href="https://unpkg.com/tabulator-tables@4.7.2/dist/css/tabulator.min.css" rel="stylesheet">
<script type="text/javascript" src="https://unpkg.com/tabulator-tables@4.7.2/dist/js/tabulator.min.js"></script>
{% endif %}

{% endblock %}

{%- block footer %}

{% if "feature-vote" in sourcename %}
<script>
    /* 
    Get chunk of up to 100 issues (max for each request)
    
    authToken See https://docs.github.com/en/graphql/guides/forming-calls-with-graphql#authenticating-with-graphql 
    cursor Where to start fetching issues from
    */
    async function fetchIssueChunk(authToken, cursor, repoName, orgName = "executablebooks", label = "enhancement", url = "https://api.github.com/graphql") {
        after = (cursor !== null) ? `, after: "${cursor}"` : ""
        query = `query {
  repository(owner: "${orgName}", name: "${repoName}") {
    name
    issues(first: 100 ${after}, states:OPEN, labels:["${label}"], orderBy: {field: CREATED_AT, direction: ASC}) {
      edges {
        node {
          number
          url
          title
          author{login, url}
          reactions(content: THUMBS_UP) {
            totalCount
          }
          bodyHTML
        }
      }
      pageInfo {
        endCursor
        hasNextPage
      }
    }
  }
}
`;
        const opts = {
            method: "POST",
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({
                query
            })
        };
        let response = await fetch(url, opts)
        let data = await response.json()
        /* format issue data */
        const issues = data.data.repository.issues.edges.map(i => {
            return {
                "repo": repoName,
                "title": i.node.title,
                "number": i.node.number,
                "url": i.node.url,
                "author": `<a href="${i.node.author.url}">${i.node.author.login}</a>`,
                "body": i.node.bodyHTML,
                "votes": i.node.reactions.totalCount
            }
        })
        return {
            issues,
            "hasNextPage": data.data.repository.issues.pageInfo.hasNextPage,
            "endCursor": data.data.repository.issues.pageInfo.hasNextPage
        }
    }

    async function fetchIssues(authToken, repoName, orgName = "executablebooks", label = "enhancement", url = "https://api.github.com/graphql", cache = true) {

        if (cache && sessionStorage.getItem(`issues-${orgName}-${repoName}-${label}`)) {
            return JSON.parse(sessionStorage.getItem(`issues-${orgName}-${repoName}-${label}`))
        }

        const issues = []
        var morePages = true
        var requests = 0 /* avoid infinite loops */
        var cursor = null
        var data

        while (morePages && requests < 99) {

            data = await fetchIssueChunk(authToken, cursor, repoName, orgName, label, url);
            issues.push(...data.issues)
            cursor = data.endCursor
            morePages = data.hasNextPage
            requests += 1
        }

        if (cache) {
            sessionStorage.setItem(`issues-${orgName}-${repoName}-${label}`, JSON.stringify(issues))
        }

        /* sort descending votes */
        return issues.sort(function (a, b) {
            return b.votes - a.votes
        });
    }

    /* See http://tabulator.info/docs/4.7/quickstart */
    var table = new Tabulator("#feature-table", {
        height: 1000, // set height of table (in CSS or here), this enables the Virtual DOM and improves render speed dramatically (can be any valid css height value)
        data: [], //assign data to table
        layout: "fitDataFill",
        responsiveLayout: "collapse", // collapse columns that no longer fit on the table into a list under the ro
        responsiveLayoutCollapseStartOpen: false,
        resizableRows: true,
        columns: [ //Define Table Columns
            {
                formatter: "responsiveCollapse",
                width: 30,
                minWidth: 30,
                hozAlign: "center",
                resizable: false,
                headerSort: false,
                responsive: 0 // never collapse
            },
            {
                title: "ID",
                formatter: "link",
                field: "number",
                formatterParams: {
                    labelField: "number",
                    urlField: "url",
                    target: "_blank"
                },
                width: 50,
                minWidth: 20,
                responsive: 0 // never collapse
            },
            {
                title: "👍",
                field: "votes",
                width: 50,
                minWidth: 20,
                responsive: 0 // never collapse
            },
            {
                title: "Title",
                field: "title",
                headerFilter: "input",
                minWidth: 50,
                responsive: 0 // never collapse
            },
            {
                title: "Repository",
                field: "repo",
                headerFilter: "input",
                minWidth: 30
            },
            {
                title: "Author",
                field: "author",
                formatter: "html",
                minWidth: 30
            },
            {
                title: "Description",
                field: "body",
                formatter: "html",
                minWidth: 9999, // always collapse
            },
        ],
    });

    const token = "7bd4b12eef0873394aad4d57bb9b537253b12a8d"

    for (repo of ["jupyter-book", "MyST-Parser", "MyST-NB", "markdown-it-py"]) {
        fetchIssues(token, repo)
            .then(
                issues => {
                    table.addData(issues);
                    table.setSort("votes", "desc");
                })
            .catch(console.error);
    }
</script>
{% endif %}

{% endblock %}
